# Chapter3. 컴퓨터 시스템의 동작 원리



## 1. 컴퓨터 시스템의 구조

- 컨트롤러: 각 하드웨어 장치를 제어하는 작은 CPU
- 커널: 운영체제 중 항상 메모리에 올라가 있는 핵심적인 부분



## 2. CPU 연산과 I/O 연산

- 로컬 버퍼: 컨트롤러가 가지고 있는, 입출력 데이터 임시 저장을 위한 작은 메모리
  - 디스크, 키보드 등에서 데이터를 읽어오는 경우 **컨트롤러**가 로컬버퍼에 데이터를 임시로 저장한다.
  - 로컬버퍼에 임시 저장이 완료되면 컨트롤러는 인터럽트를 발생시켜 CPU가 알게 한다.
  - CPU는 명령 하나를 수행할 때마다 인터럽트가 발생했는지 확인하고 인터럽트 발생시 인터럽트 처리를 먼저 한다.

## 3. 인터럽트의 일반적 기능

인터럽트에는 하드웨어 인터럽트와 소프트웨어 인터럽트가 있고, 둘 다 CPU 옆에 있는 인터럽트 라인에 신호를 보내 인터럽트가 발생했음을 알리는 방식이다.

운영체제는 인터럽트 종류별로 **인터럽트 벡터**를 가지고 있어서, 인터럽트 발생 시 해당 인터럽트 처리루틴의 코드를 찾아간다.

- 하드웨어 인터럽트
  - 컨트롤러가 CPU의 인터럽트 라인을 세팅, 통상적으로 인터럽트는 하드웨어 인터럽트를 의미(입출력 등 발생시)
- 소프트웨어 인터럽트
  - 소프트웨어가 CPU의 인터럽트 라인을 세팅, 트랩이라고 불림. exception과 system call로 나눠 부름.
  - exception: 비정상적인 작업 시도 혹은 권한이 없는 작업 시도시 발생
  - system call: 운영체제 커널에 있는 코드를 사용자 프로그램에서 실행하고자 할 때 발생

## 4. 인터럽트 핸들링

인터럽트 핸들링이란 인터럽트가 발생한 경우에 처리해야 할 일의 절차를 의미한다.

프로그램 A에서 인터럽트 발생 시 PCB에 A의 현재 상태를 저장한다.

- PCB(Process Control Block)
  - 운영체제에서 현재 실행되는 프로그램들을 관리하기 위한 자료구조
  - 각 프로그램마다 하나씩 존재하며, 프로그램이 실행 중이던 정보(코드의 메모리 주소, 레지스터값, 하드웨어 상태 등)를 저장
  - 인터럽트 처리가 끝난 후 원래 진행 중이던 프로그램의 상태를 PCB로부터  CPU상에 복원하여 다시 실행한다.

:bulb:오늘 날 운영체제는 인터럽트에 의해서만 CPU를 점유하는 방식을 통해 컴퓨터 시스템 자원을 체계적이고 효율적으로 관리할 수 있다.



## 5. 입출력 구조



- 동기식 입출력 - 작업이 완료된 후에야 프로그램이 후속 작업을 수행한다.
  - CPU 연산이 입출력 연산보다 훨씬 빠르기 때문에 입출력 연산을 기다렸다가 CPU 연산을 시작하면 자원의 낭비가 심해진다.
  - 자원 낭비를 관리하기 위해 운영체제는 입출력 중인 프로그램에게는 CPU를 할당하지 않고(봉쇄 상태) 곧바로 명령 수행 가능한 프로그램에 CPU를 할당한다.
  - 입출력 중인 프로그램 사이에서는 동기화(입출력 순서대로 처리)를 위해 장치별로 큐를 두어 요청한 순서대로(선입선출) 처리할 수 있도록 한다.

- 비동기식 입출력 - CPU의 제어권이 입출력을 요청한 프로세스에게 곧바로 다시 주어짐. 입출력 연산이 완료되는 것과 무관하게 처리 가능한 작업부터 처리.

일반적으로 동기식 입출력을 사용하는데, 자원의 낭비를 막기 위해 위의 설명처럼 입출력 요청시 해당 프로그램을 봉쇄하는 방법을 사용한다.



## 6. DMA

DMA(Direct Memory Access)

원칙적으로 메모리는 CPU에 의해서만 접근할 수 있는 장치이고, CPU외의 장치가 메모리의 데이터에 접근하기 위해서는 CPU에게 인터럽트를 발생시켜 CPU가 이를 대행하는 식으로만 가능하다.

CPU가 과한 인터럽트를 당하는 것을 막기 위해서 CPU가 아님에도 메모리 접근이 가능한 장치를 두며, 이를 DMA라고 한다.



## 7. 저장장치의 구조

- 주기억 장치
  - RAM, 휘발성
- 보조기억 장치
  - 마그네틱 디스크(하드디스크), 플래시 메모리, CD 등 비휘발성
  - 전원이 나가도 유지해야 할 정보를 저장하는 **파일시스템 용**, 메모리의 연장 공간인 **스왑 영역**의 두 가지 용도를 가진다.
  - 메모리 부족을 해결하기 위해 운영체제가 당장 불필요한 부분은 메모리에서 스왑 영역으로 내려놓는다.



## 8. 저장장치의 계층 구조

상위( 접근속도 up, 용량 down)

---

- 레지스터
- 캐시 메모리
- 메인 메모리

---

- 마그네틱 디스크
- 광디스크
- 마그네틱 테이프

---

하위

저장장치는 위와 같이 상위로 갈수록 속도는 빨라지지만 용량은 작아진다. 하지만 당장 필요한 정보만 저장하는 캐싱 기법으로 상위 저장장치를 하위 저장장치와 비슷한 용량을 가진 것처럼 사용할 수 있다.



## 9. 하드웨어의 보안

다중 프로그래밍 환경에서 발생하는 문제들에 대한 보안 기법

- 커널모드와 사용자 모드
  - 중요한 정보에 접근해 위험한 상황을 초래할 수 있는 연산은 커널모드에서만 실행
  - 일반적인 연산만 사용자모드에서 실행
  - 사용자 프로그램 내에서 자체적으로 중요한 정보에 접근하는 연산을 수행하는 경우가 있을 수 있음 -> 하드웨어적인 지원이 필요 -> mode bit
  - mode bit : 0 
    - 커널모드로서 모든 명령 수행 가능
  - mode bit : 1
    - 사용자모드로서 제한된 명령만 수행 가능



:bulb: 모든 **입출력 명령은 특권명령**으로 규정한다.

특권명령으로 규정함으로써 **사용자 프로그램이 직접 입출력하는 것을 차단**한다.

입출력이 필요한 경우에는 인터럽트(시스템 콜)를 통해 운영체제에 요청하여 모드비트를 0으로 세팅하여야만 인터럽트 처리루틴으로 이동하여 입출력 처리를 할 수 있다.



## 10. 메모리 보안

2개의 레지스터를 사용해서 프로그램이 접근하려는 메모리 부분이 합법적인지 체크하여 메모리를 보호한다.

- 기준 레지스터
  - 프로그램이 수행되는 동안 접근 가능한 가장 작은 주소를 보관
- 한계 레지스터
  - 프로그램이 접근할 수 있는 메모리의 범위를 보관

범위를 벗어나는 접근은 예외상황 소프트웨어 인터럽트를 발생시킴



## 11. CPU 보호

특정 프로그램이 CPU의 사용을 독점하는 것을 막기 위해 타이머를 사용

=> 정해진 시간이 지나면 인터럽트를 발생시키고, 운영체제가 CPU 제어권을 획득



## 12. 시스템 콜을 이용한 입출력 수행

사용자 프로그램은 입출력 명령을 직접 수행할 수 없으므로 운영체제에게 시스템 콜이라는 서비스 대행 요청을 하여 입출력을 수행한다.