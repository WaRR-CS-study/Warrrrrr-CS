# Chapter4. 프로그램의 구조와 실행



## 1. 프로그램의 구조와 인터럽트

프로그램의 주소 영역은 3 가지로 구분된다.

- 코드 영역: 작성한 프로그램 함수들의 코드가 CPU에서 수행할 수 있는 기계어 명령 형태로 변환되어 저장
- 데이터 영역: 전역 변수등 프로그램이 사용하는 데이터를 저장
- 스택 영역: 함수가 호출될 때 호출된 함수의 수행을 마치고 복귀할 주소 및 데이터를 임시 저장



인터럽트가 발생하면 CPU는 기존에 하던 작업을 스택에 둔 채로 인터럽트 처리루틴으로 넘어가 새로운 함수를 실행한다.  

- 일반적으로 프로그램 내에서 발생되는 함수호출에 필요한 복귀 주소는 **각 프로그램의 스택 영역**에 보관한다.

- 하지만 인터럽트때문에 CPU를 빼앗긴 위치는 운영체제가 관리하는 **프로세스 제어 블록**(어느 부분까지 실행되었었는지 저장)에 저장된다.





## 2. 컴퓨터 시스템의 작동 개요

### 프로그램 카운터(PC)

- CPU가 수행해야할 메모리 주소를 담고있는 레지스터
- CPU는 프로그램 카운터가 가리키는 메모리 위치의 명령어를 처리한다.



- 커널 모드(kernel mode) : 프로그램 카운터가 운영체제가 존재하는 메모리를 가리키는 경우. 즉, 운영체제 코드를 수행중인 경우

- 사용자 모드(user mode) : 위와 반대



### CPU가 수행하는 명령

- 일반명령
  - 모든 프로그램이 수행 가능, 메모리에서 자료를 읽어와 CPU에서 연산
- 특권명령
  - 입출력 장치, 타이머 등 각종 장치에서 접근하는 명령으로, 운영체제만이 수행 가능(3장)
- 모드 비트(3장)



운영체제만이 수행 가능한 특권명령을 사용자 프로그램이 실행하려고 하는 경우 운영체제에 특권명령 대행을 요청하는 것을 **시스템 콜**이라고 한다.

시스템 콜을 하면 사용자 영역이 아닌 커널 영역에서 코드를 처리한다.



### CPU가 인터럽트를 확인하는 방법

- CPU는 프로그램 카운터가 가리키는 메모리 위치의 명령만 확인하므로 주변 장치의 상태를 모른다. 그래서 매번 명령을 수행한 직후 인터럽트 라인을 체크한다.



## 3. 프로그램의 실행

### 프로그램 실행이란?

- 디스크에 존재하던 실행 파일이 메모리에 적재됨
- 프로그램이 CPU를 할당받고 명령을 수행하는 상태

*실행파일이 적재될 때, 실행파일 전체가 메모리에 한꺼번에 올라가기보다는 일부분만 메모리에 올리고 나머지는 디스크의 특정 영역에 내려가 있다.

 

4.1에서 살펴본 바와 같이 프로세스의 주소 공간은 코드, 데이터, 스택으로 구성되며, 이러한 주소 공간을 **가상 메모리(7장)** 또는 논리적 메모리라고 부른다.

운영체제 역시 하나의 프로그램으로, **운영체제 커널 역시 코드, 데이터, 스택으로 구성된 주소 공간**을 가진다.



### 커널

**데이터 영역**

- 시스템 내 모든 자원을 관리하기 위한 자료구조를 각각 유지하고 있는 영역
- 프로세스 : 현재 수행중이 프로그램
- PCB : 각 프로세스의 상태, CPU의 사용정보, 메모리 사용 정보등을 유지하기 위한 자료구조
- PCB를 관리하기 위한 큐(chapter5.5)



**스택 영역**

- 일반 프로그램의 스택 영역과 동일하게 함수 호출 복귀 주소를 저장하기 위한 용도
- (차이점 📌) 사용자 프로그램 스택과 달리, 프로세스마다 별도의 스택을 두어 관리한다.
- (정리) 프로그램이 자기자신 내의 코드 실행에서는 자신의 스택을 사용하고, 시스템 콜이나 인터럽트 시에는 커널 스택을 사용한다.



## 4. 사용자 프로그램이 사용하는 함수

프로그램은 결국 함수의 집합이라고 할 수 있으며 **사용자 프로그램이 사용하는 함수는 3가지**가 있다.

1. 사용자 정의 함수

   사용자가 직접 작성한 함수

   

2. 라이브러리 함수

   사용자가 직접 작성하지는 않았지만 누군가 작성하여 사용하게된 함수

   

3. 커널 함수

   운영체제 커널에 정의된 함수



## 5. 인터럽트

CPU는 매 명령어 수행 후에 인터럽트 라인 체크를 통해 인터럽트를 확인

### 인터럽트 처리 중 인터럽트가 발생 한 경우

- 원칙적으로는 이러한 상황이 발생하는 것을 허용하지 않는다.
  - 데이터의 일관성이 유지 되지 않는 문제
  - 이중으로 동일한 데이터를 바꾸려는 경우 원하는 동작이 되지 않음.
- 하지만 현재 인터럽트보다 우선순위가 높은 인터럽트 발생시 우선순위가 높은 것 먼저 처리한다.



## 6. 시스템 콜

시스템 콜이란 사용자 프로그램이 특권명령을 수행해야할 경우 사용자 프로그램이 직접 명령을 내릴 수 없기 때문에 OS에게 요청하는 것을 의미한다.



## 7. 프로세스의 두 가지 실행 상태

어떠한 사용자 프로그램이 실행 되는 것은 **사용자 모드에서의 실행 상태**라고 하며 시스템 콜이 들어와서 커널에서 실행될 경우 **커널 모드에서의 실행 상태**라고 한다. 