# 📙 Chapter7. 메모리 관리

[toc]

## 1. 주소 바인딩

 주소 바인딩이란 **프로세스의 논리적 주소를 물리적 주소로 연결시켜주는 작업**이다.

※ 물리적 메모리의 낮은 주소 영역에는 운영체제가 올라가고 높은 주소 영역에는 사용자 프로세스들이 올라간다.



- 논리적 주소 : 프로그램이 실행되었을때 메모리에 적재된 주소 공간의 주소
- 물리적 주소 : 실제 저장된 물리적 주소



### ⭐ 주소 바인딩 방식

주소 바인딩 방식은 프로그램이 적재되는 물리적 메모리 주소가 결정되는 시기에 따라 분류된다.



1. 컴파일 타임 바인딩 : 물리적 메모리 주소가 프로그램을 컴파일할 때 결정되는 방식

   

2. 로드 타임 바인딩 : 프로그램이 실행되기 시작할 때 물리적 메모리 주소가 결정되는 방식

   

3. 실행 시간 바인딩 : 프로그램이 실행을 시작한 후에도 그 프로그램이 위치한 물리적 메모리상의 주소가 변경될 수 있는 방식




#### 	⭐ MMU 기법

​		 **MMU는 하드웨어 장치로 논리적 주소와 물리적 주소로 매핑해주는 장치이다.** CPU가 특정 프로세스의 논리적 주소를 참조하려고 할 때 MMU 기법은 그 주소값에 기준 레지스터의 값을 더해 물리적 주소값을 얻어낸다. 이때 기준 레지스터는 재배치 레지스터라고도 부르며 그 프로세스의 물리적 메모리 시작 주소를  갖고 있다.

​		  하지만 다중 프로그래밍 환경에서 물리적 메모리 안에 여러 개의 프로세스가 동시에 올라가 있어 논리적 주소값과 재배치 레지스터 값을 더하면 해당 프로세스의 주소공간을 벗어나는 경우가 발생할 수 있다. 이렇게 되면 메모리 보안이 깨질 우려가 있어 주소공간이 벗어나는지를 파악하기 위한 한계 레지스터를 사용한다.



#### 메모리 보안을 달성하는 법

논리주소 값이 한계 레지스터 내에 저장된 프로세스 크기 보다 작은지 확인

- 큰 경우 : 다른 프로세스의 메모리 영역에 접근하는 행위로 간주하여 트랩을 발생 -> 강종
- 작은 경우 : 재배치 레지스터 값을 더해 물리적 주소를 구하여 접근한다.



## 2. 메모리 관리와 관련된 용어

### 2.1 동적 로딩

- 다중 프로그래밍 환경에서 메모리 효율을 높이기 위한 방법 중 하나
- 프로세스의 특정 부분이 불릴 때 그 부분만 메모리에 적재하는 방식



### 2.2 동적 연결

- 목적파일(소스코드 컴파일)과 라이브러리 파일(이미 컴파일된 파일) 사이의 연결을 프로그램의 실행까지 지연지시키는 방법
- 정적 연결(목적 파일과 라이브러리 파일을 합쳐 놓은 것)은 실행 파일의 크기가 크고, 각 프로세스별로 라이브러리를 각각 적재해서 메모리 낭비가 심한데 이와 반대 개념이다.
- 프로그램이 실행되면서 라이브러리 함수를 호출할때 불러오는 방식



### 2.3 중첩

- 프로세스의 주소공간을 분할하여 실제 필요한 부분만 메모리에 적재
- 과거에 메모리 크기의 제약으로 하나의 프로세스 조차 다 못올리는 경우에 당장 필요한 부분만 메모리에 올리고, 그 부분이 끝나야 나머지 부분을 올리는 방식이라 동적로딩과는 다르다.
- 즉, 동적 로딩은 더 많은 프로세스를 동시에 올려놓고 쓰기 위한 이용률 향상 목적이고, 중첩은 메모리 용량보다 큰 프로세스를 실행하기 위한 어쩔수 없는 선택이었다.
- 운영체제 지원 없이 프로그래머가 구현했으며, 상당히 복잡하다.



### 2.4 스와핑

- 메모리에 올라온 프로세스의 주소 공간 전체를 디스크의 스왑영역(백킹스토어)에 일시적으로 내려놓는것.
- 프로세스 수행 중 일시적으로 저장하는 짧은 저장공간



## 3. 물리적 메모리의 할당 방식

### 3.1 연속 할당 방식



- 프로세스를 메모리에 올릴 때 그 주소 공간을 여러 개로 분할하지 않고 물리적 메모리의 한 곳에 연속적으로 적재하는 방식



1. 고정 분할 방식

   물리적 메모리를 주어진 개수만큼의 영구적인 분할로 미리 나누어두고 각 분할에 하나의 프로세스를 적재해 실행시킬 수 있도록 한다.

   

2. 가변 분할 방식

   고정분할 방식과 달리 메모리에 적재되는 프로그램의 크기에 따라 분할의 크기, 개수가 동적으로 변하는 방식,

   ※ 동적 메모리 할당 문제

   메모리의 어떤 위치에 올릴 것인지 결정하는 문제로 가용 공간을 찾아 프로세스를 올리는 것이다.

   - 최초적합 방법 - 가장 먼저 찾아지는 곳에 할당

   - 최적적합 방법 - 올라갈 수 있는 크기 중 가장 작은 크기

   - 최악적합방법 - 가장 크기가 큰 곳에 할당

     

### 3.2 불연속 할당 방식

 하나의 프로세스가 물리적 메모리의 여러 위치에 분산되어 올라갈 수 있는 메모리 할당 기법이다.

**세그멘테이션 기법, 페이지드 세그멘테이션 기법 등**이 있다.



## ⭐ 4. 페이징 기법

- 프로세스의 주소 공간을 동일한 크기의 페이지 단위로 나누어 물리적 메모리의 서로 다른 위치에 **페이지**들을 저장하는 방식이다.

- 페이징 기법에서는 물리적 메모리와 동일한 크기의 **프레임**으로 미리 나누어둔다. 



### 4.1 주소 변환 기법

- 특정 프로세스의 p번째 페이지가 위치한 물리적 메모리의 시작 위치는 프로세스의 페이지 테이블에서 p번째 항목을 찾아보는 방식이다.

- 페이지 오프셋은 페이지 내에서의 변위(displacement)를 알려준다. 즉 기존 주소값 p에 변위인 d를 더해 물리적 주소를 얻는 것이다.



### 4.2 페이지 테이블의 구현

- 주소 변환을 하기 위한 자료구조로, 물리 메모리에 위치함.
- `테이블 기준 레지스터`(메모리 내에서 페이지 테이블의 시작 위치)와 `페이지 테이블 길이 레지스터 `(페이지 테이블의 길이) 로 페이지 테이블에 접근한다.
- 페이징에서의 메모리 접근 연산
  - 주소 변환을 위해 페이지 테이블에 접근하는 것
  - 변환된 주소에서 실제 데이터에 접근하는 것
  - 위 2번이나 접근해야하는 오버헤드가 뒤따라서 `TLB`를 사용한다.



#### TLB(Translation Look-aside Buffer)

- 고속의 주소 변환용 하드웨어 캐시
- 가격이 비싸서 테이블의 모든 정보는 담지 못하고 자주 참조되는 페이지 정보만 담는다.
- 현재 요청하는 페이지가 TLB에 있으면 곧 바로 물리 메모리 프레임을 얻을 수 있다.
- 그렇지 않으면 페이지 테이블을 참조 하여야 하고, TLB의 기존 내용을 지우고 새로운 내용을 담는다.



### 4.3 계층적 페이징

- 현대의 컴퓨터는 주소 공간이 매우 큰 프로그램을 지원하기 때문에 계층적 페이징 기법을 지원한다. 이 기법은 앞서 비유한 바 대로 주소지를 나눈다고 생각하면 편하다. 즉 대전시 유성구 덕명동처럼 계층을 나누어 차례대로 접근하는 방식이다. 현재는 주로 2단계 페이징 기법을 사용하는데 이 때 먼저 접근하는 것을 외부 페이지 테이블이라고 하며 다음에 접근하는 것을 내부 페이지 테이블이라고 한다.



### 4.4 역페이지 테이블

- 역페이지 테이블 기법은 물리적 메모리의 페이지 프레임 하나당 페이지 테이블에 하나씩의 항목을 두는 방식

- 페이지 테이블 방식이 낭비가 심한 이유는 기본적으로 프로세스의 모든 페이지에 대한 페이지 테이블 항목을 다 구성해야 하기 때문이다. 

- 역페이지 테이블은 이 비효율을 해결하기 위한 기법으로 사용될 수 있다. 



### 4.5 공유 페이지

- 공유 코드 : 메모리 공간의 효율을 위해 여러 프로그램에서 공통으로 사용될 수 있도록 작성한 코드
- 재진입 가능 코드 또는 순수 코드라고도 하며, **읽기 전용**이다.



### 4.6 메모리 보호

- 페이지 테이블 각 항목에는 주소변환 뿐만 아니라 보호비트와, 유효-무효 비트를 두고 있다.
- 보호 비트 : 각 페이지에 대한 접근 권한 허용
- 유효- 무효 비트 : 해당 페이지 내용이 유효한지(그 페이지가 존재 하는지)



## 5. 세그먼테이션

 앞서 살펴본 페이지 기법이 프로세스를 동일한 크기 단위의 페이지로 나누었다면 세그멘테이션 기법은 의미 단위인 세그먼트로 나누어 올리는 방식을 말한다. 

 세그멘테이션 기법은 세그멘트의 크기에 대한 정보와 세그멘트의 시작점에 대한 정보를 가진 두개의 테이블이 있으며 세그먼트 테이블 기준 레지스터(Segment Table Base Register)와 세그먼트 테이블 길이 레지스터(Segment Table Length Register)를 사용하여 접근한다. 

 이때 세그먼트의 길이 + 논리적 주소를 더했을 때 해당 프로세스에 할당된 limit 기준을 넘어가게 되면 Trap이 발동되어 멈추며 limit이 넘지 않을 경우 아닐 경우 해당 위치를 찾게 된다. (210p 참조)

 세그먼테이션 기법은 앞서 페이징 기법에서 사용된 메모리 보호 기능과 공유 페이지 기능이 모두 구현되어 있다.

 세그멘테이션 기법은 기능 단위로 나뉘어져 있어서 페이징 기법보다 공유와 보안 측면이 훨씬 효과적이다. 즉 접근 권한의 설정이 용이한 것이다.  





## 6. 페이지드 세그먼테이션

 페이지드 세그멘테이션 기법은 페이징 기법과 세그먼테이션 기법의 결합으로 각 세그먼트의 크기를 페이징의 정수배로 고정하여 페이징 기법처럼도 활용할 수 있는 기법이다. 페이지드 세그멘테이션의 주소 변환을 위해서는 외부의 세그멘트 테이블과 내부의 페이지 테이블이 있는데 이를 사용하는 것은 앞서 살펴본 2단계 페이지 테이블 기법과 유사한 구조이다.

 즉 세그멘트 테이블을 통해 내부의 페이지 테이블로 접근하여 그 세그멘트가 어떤 페이지에 있는지를 알아내고 이 페이지 테이블을 활용하여 물리적 주소를 얻어내는 방식이다.